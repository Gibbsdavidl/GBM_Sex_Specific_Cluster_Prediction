---
title: An R Markdown document converted from "STEP_3_Feature_Selection_Processing_V3.ipynb"
output: html_document
---

```{r}
#devtools::install_github("gibbsdavidl/robencla", force = F)
```

```{r}
library(tidyverse)
```

```{r}

array_m <- read.csv('../data/Male_Feature_Search_Data.csv.gz')

resdf_m <- read_csv('../results/feature_selection_table_male.csv')

table(resdf_m$cluster)

```

```{r}

# first get the min values for each gene
minExprVals <- sapply (2:10343, function(i) {
  gene <- colnames(array_m)[i]
  min(array_m[,i])
})

names(minExprVals) <- colnames(array_m)[2:10343]

# not used, but have the names of genes with min expr values over 4.6
selected_genes <- names(minExprVals)[minExprVals > 4.6]

# get the names of genes from the array data
getgenecols <- function(gene_i, gene_j, array_m, x)  {
  gene_names <- colnames(array_m)[c(gene_i, gene_j)]
  return(gene_names)
}

# get the min values for those gene pairs
makenewcols <- function(gene_i, gene_j, array_m, x)  {
  gene_names <- colnames(array_m)[c(gene_i, gene_j)]
  minvals <- x[gene_names]
  return(minvals)
}

# call the function
minvallist <- lapply(1:nrow(resdf_m), function(i) {
  makenewcols(unlist(resdf_m[i, 'gene_i']), unlist(resdf_m[i, 'gene_j']), array_m, minExprVals)
})

# call function
genelist <- lapply(1:nrow(resdf_m), function(i) {
  getgenecols(unlist(resdf_m[i, 'gene_i']), unlist(resdf_m[i, 'gene_j']), array_m, minExprVals)
})

# transform into tables
minvalmat <- do.call('rbind', minvallist)
genemat <- do.call('rbind', genelist)

# and add to the pairs table
annotdf_m <- resdf_m
annotdf_m['gene_i_symbol'] <- genemat[,1]
annotdf_m['gene_j_symbol'] <- genemat[,2]
annotdf_m['gene_i_min'] <- minvalmat[,1]
annotdf_m['gene_j_min'] <- minvalmat[,2]


```



```{r}

getpairs <- function(pairmat, cluster_c, thresh, topn) {

    # first filter the table by min expression value
    filtmat <- pairmat[ (pairmat$gene_i_min > thresh) & (pairmat$gene_j_min > thresh) & (pairmat$cluster == cluster_c), ]
    
    #idx <- order(filtmat$dist_ij_cluster, decreasing = T)[1:topn]
    #jdx <- order(filtmat$dist_ij_cluster, decreasing = F)[1:topn]
    idx <- order(filtmat$prop_diff, decreasing = T)[1:topn]
    jdx <- order(filtmat$prop_diff, decreasing = F)[1:topn]

    upgenes <- c()
    for (i in idx) {
      upgenes <- c(upgenes, as.character(filtmat[i, 'gene_i_symbol']))
      upgenes <- c(upgenes, as.character(filtmat[i, 'gene_j_symbol']))
    }
    dngenes <- c()
    for (j in jdx) {
      dngenes <- c(dngenes, as.character(filtmat[j, 'gene_i_symbol']))
      dngenes <- c(dngenes, as.character(filtmat[j, 'gene_j_symbol']))
    }

    return( c(upgenes, dngenes) )    
}

genepairs <- list(
  'cluster1'=getpairs(annotdf_m, 'cluster1', 4.6, 5),
  'cluster2'=getpairs(annotdf_m, 'cluster2', 4.6, 5),
  'cluster3'=getpairs(annotdf_m, 'cluster3', 4.4, 5),
  'cluster4'=getpairs(annotdf_m, 'cluster4', 4.6, 5),
  'cluster5'=getpairs(annotdf_m, 'cluster5', 4.5, 5)
)

```

```{r}
genepairs
```

```{r}
save(genepairs, file='../results/males_genepairs.rda')
```



# Now for the female samples # 





```{r}
### PULLING OUT SOME GENES

array_f  <- read.csv('../data/Female_Feature_Search_Data.csv.gz')

resdf_f <- read_csv('../results/feature_selection_table_female.csv')

table(resdf_f$cluster)

```

```{r}
# first get the min value for each gene in the array data
minExprVals <- sapply (2:10343, function(i) {
  gene <- colnames(array_f)[i]
  min(array_f[,i])
})

names(minExprVals) <- colnames(array_f)[2:10343]  # last col is cluster ID


selected_genes <- names(minExprVals)[minExprVals > 4.6]


getgenecols <- function(gene_i, gene_j, array_f, x)  {
  gene_names <- colnames(array_f)[c(gene_i, gene_j)]
  return(gene_names)
}


makenewcols <- function(gene_i, gene_j, array_f, x)  {
  gene_names <- colnames(array_f)[c(gene_i, gene_j)]
  minvals <- minExprVals[gene_names]
  return(minvals)
}


minvallist <- lapply(1:nrow(resdf_f), function(i) {
  makenewcols(unlist(resdf_f[i, 'gene_i']), unlist(resdf_f[i, 'gene_j']), array_f, minExprVals)
})


genelist <- lapply(1:nrow(resdf_f), function(i) {
  getgenecols(unlist(resdf_f[i, 'gene_i']), unlist(resdf_f[i, 'gene_j']), array_f, minExprVals)
})


minvalmat <- do.call('rbind', minvallist)
genemat <- do.call('rbind', genelist)


annotdf_f <- resdf_f
annotdf_f['gene_i_symbol'] <- genemat[,1]
annotdf_f['gene_j_symbol'] <- genemat[,2]
annotdf_f['gene_i_min'] <- minvalmat[,1]
annotdf_f['gene_j_min'] <- minvalmat[,2]


```





```{r}

# previously took prop_diff into account also
# resdf %>% dplyr::filter(cluster=='cluster1') %>% arrange( desc(abs(dist_ij_cluster))) %>% head(n=20)
# resdf %>% dplyr::filter(cluster=='cluster1') %>% arrange( desc(abs(prop_diff))) %>% head(n=20)

getpairs <- function(pairmat, cluster_c, thresh, topn) {

    # first filter the table by min expression value
    filtmat <- pairmat[ (pairmat$gene_i_min > thresh) & (pairmat$gene_j_min > thresh) & (pairmat$cluster == cluster_c), ]
    
    #idx <- order(filtmat$dist_ij_cluster, decreasing = T)[1:topn]
    #jdx <- order(filtmat$dist_ij_cluster, decreasing = F)[1:topn]
    idx <- order(filtmat$prop_diff, decreasing = T)[1:topn]
    jdx <- order(filtmat$prop_diff, decreasing = F)[1:topn]
    
    upgenes <- c()
    for (i in idx) {
      upgenes <- c(upgenes, as.character(filtmat[i, 'gene_i_symbol']))
      upgenes <- c(upgenes, as.character(filtmat[i, 'gene_j_symbol']))
    }
    dngenes <- c()
    for (j in jdx) {
      dngenes <- c(dngenes, as.character(filtmat[j, 'gene_i_symbol']))
      dngenes <- c(dngenes, as.character(filtmat[j, 'gene_j_symbol']))
    }

    return( c(upgenes, dngenes) )    
}

genepairs <- list(
  'cluster1'=getpairs(annotdf_f, 'cluster1', 4.6, 5),
  'cluster2'=getpairs(annotdf_f, 'cluster2', 4.6, 5),
  'cluster3'=getpairs(annotdf_f, 'cluster3', 4.6, 5),
  'cluster4'=getpairs(annotdf_f, 'cluster4', 4.2, 5),
  'cluster5'=getpairs(annotdf_f, 'cluster5', 4.6, 5)
)

```

```{r}
genepairs
```


```{r}
save(genepairs, file='../results/females_genepairs.rda')
```

