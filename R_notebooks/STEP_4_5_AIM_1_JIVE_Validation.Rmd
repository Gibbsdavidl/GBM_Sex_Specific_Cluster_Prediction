---
title: "STEP_4_5_AIM_1_JIVE_validation.Rmd"
output: html_document
date: "2023-10-21"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}

if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("GEOquery")

library(GEOquery)

library(org.Hs.eg.db)
```

## JIVE Validation

In the JIVE manuscript, there are three array expression data sets used for validation:
 GSE13041, GSE16011, and REMBRANDT

See: https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE55918
https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE13041
https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE16011
https://link.springer.com/article/10.1007/s13402-014-0190-8#Sec20

```{r}
# load series and platform data from GEO
gset13041 <- getGEO("GSE13041", GSEMatrix =TRUE, AnnotGPL=TRUE)
gset16011 <- getGEO("GSE16011", GSEMatrix =TRUE, AnnotGPL=TRUE)
gsetPheno <- read_delim('../data/validation_metadata/GBM_meta_analysis.txt')

save(gset13041, gset16011, file = '../data/jive_validation_array_data.rda')


# make proper column names to match toptable 
fvarLabels(gset13041[[1]]) <- make.names(fvarLabels(gset13041[[1]]))
fvarLabels(gset13041[[2]]) <- make.names(fvarLabels(gset13041[[2]]))
fvarLabels(gset13041[[3]]) <- make.names(fvarLabels(gset13041[[3]]))

ex1 <- exprs(gset13041[[1]])
ex2 <- exprs(gset13041[[2]])
ex3 <- exprs(gset13041[[3]])

ph1 <- phenoData(gset13041[[1]])
ph2 <- phenoData(gset13041[[2]])
ph3 <- phenoData(gset13041[[3]])

phenotype_data1 <- pData(ph1)
phenotype_data2 <- pData(ph2)
phenotype_data3 <- pData(ph3)

sym1 <- fData(gset13041[[1]])$Gene.symbol
sym2 <- fData(gset13041[[2]])$Gene.symbol
sym3 <- fData(gset13041[[3]])$Gene.symbol

df1 <- as.data.frame(t(ex1))
colnames(df1) <- sym1
df1[['sample']] <- rownames(df1)

df2 <- as.data.frame(t(ex2))
colnames(df2) <- sym2

df3 <- as.data.frame(t(ex3))
colnames(df3) <- sym3


pdf1 <- phenotype_data1[, c('geo_accession', 'characteristics_ch1.1', 'characteristics_ch1.2',
                            'characteristics_ch1.3', 'characteristics_ch1.4','characteristics_ch1.5', 'characteristics_ch1.6')]

pdf2 <- phenotype_data2[, c('geo_accession', 'characteristics_ch1.1', 'characteristics_ch1.2',
                            'characteristics_ch1.3', 'characteristics_ch1.4','characteristics_ch1.5', 'characteristics_ch1.6')]

pdf3 <- phenotype_data3[, c('geo_accession', 'characteristics_ch1.1', 'characteristics_ch1.2',
                            'characteristics_ch1.3', 'characteristics_ch1.4','characteristics_ch1.5', 'characteristics_ch1.6')]


```

Then we need to convert the probeIDs to gene symbols




```{r}

# load up the model
load('../models/females_tcga_array_step4.rda')

# load up the gene pairs used
load('../results/females_genepairs.rda')

# check what genes might be missing
unlist(genepairs) [! unlist(genepairs) %in% colnames(df1) ]
# cluster23 cluster213 
#   "PTCD1"     "CCT3" 

expr1 <- df1

colnames(expr1)[6]  <- "PTCD1"

colnames(expr1)[7]  <- "CCT3"    

unlist(genepairs) [! unlist(genepairs) %in% colnames(expr1) ]

buffy$predict(data_frame = expr1,
              sample_id = 'sample')
   
```


