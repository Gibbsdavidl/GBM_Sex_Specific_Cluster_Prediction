---
title: An R Markdown document converted from "STEP_4_AIM_1_CV_Pairs.ipynb"
output: html_document
---

Changes:

* Subsetting to genes that are present in all data sources.. array, RNA-seq, and TEMPUS. 10363 genes.
* Subsetting the JIVE gene signatures to those present genes.

Questions: Are there missing genes, in array, that are present in RNA-seq, that would be better to have for TEMPUS?



```{r}
devtools::install_github("gibbsdavidl/robencla", force = T)
```

```{r}
library(tidyverse)
library(robencla)
```


```{r}
dat.m <- read_csv('../../data/Males_Array_Data_CW.csv')
#load("data/Males_feature_sel_genelist.rda")
load("../../data/feature_pairs_male_v3_round3.rda")
# removing signature genes that are not available in our data sets
male.jive.gene.list <- readRDS("../../data/Males_jive_cluster_genes_CW.rds") %>% dplyr::filter(value %in% colnames(dat.m))
```

```{r}
table(dat.m$cluster.group)
```

```{r}
genelist
```

```{r}
dim(dat.m)
```

```{r}
genelist_m <- genelist

sigs.m <- list("C1"=male.jive.gene.list$value[male.jive.gene.list$cluster.group == 'cluster1'],
               "C2"=male.jive.gene.list$value[male.jive.gene.list$cluster.group == 'cluster2'],
               "C3"=male.jive.gene.list$value[male.jive.gene.list$cluster.group == 'cluster3'],
               "C4"=male.jive.gene.list$value[male.jive.gene.list$cluster.group == 'cluster4'],
               "C5"=male.jive.gene.list$value[male.jive.gene.list$cluster.group == 'cluster5']
)

# our classifier object named Anne.
anne <- Robencla$new("Anne")

  # xgboost parameters to pass to each sub-classifier in the ensembles
  params <- list(max_depth=12,   # "height" of the tree, 6 is actually default. I think about 12 seems better.  (xgboost parameter)
                 eta=0.2,        # this is the learning rate. smaller values slow it down, more conservative   (xgboost parameter)
                 nrounds=24,     # number of rounds of training, lower numbers less overfitting (potentially)  (xgboost parameter)
                 nthreads=5,     # parallel threads
                 gamma=0.5,      # Minimum loss reduc req'd to again partition a leaf node. higher number ~ more conservative (xgboost parameter)
                 lambda=1.5,     # L2 regularization term on weights, higher number ~ more conservative (xgboost parameter)
                 alpha=0.5,      # L1 regularization term on weights. higher number ~ more conservative (xgboost parameter)
                 verbose=0,
                 train_perc=0.8,
                 combine_function='median',
                 size=11
  )
```

```{r}
# First we use the training data
anne$autocv(data_frame=dat.m,
            label_name='cluster_group',
            sample_id = 'sample',
            data_mode=c('pairs'), # pairs,allpairs,sigpairs,quartiles,tertiles,binarize,ranks,original #
            signatures=NULL,
            pair_list=genelist_m,  # subset to these genes.
            params=params,
            cv_rounds=10
            )
```

```{r}
df.m <- anne$cv_results
df.m$cluster1 <- as.numeric(df.m$cluster1)
df.m$cluster2 <- as.numeric(df.m$cluster2)
df.m$cluster3 <- as.numeric(df.m$cluster3)
df.m$cluster4 <- as.numeric(df.m$cluster4)
df.m$cluster5 <- as.numeric(df.m$cluster5)
head(df.m)

write.table(as.data.frame(df.m), 'results/male_cv_pairs_round2.csv', sep=',', quote = F, row.names = F)
```

```{r}
df.m <- read.csv('results/male_cv_pairs_round2.csv')

tabdf <- table(Pred=df.m$BestCalls, True=df.m$Label)

tabtbl <- as.data.frame(tabdf) %>% 
  pivot_wider(id_cols = Pred,names_from = True, values_from = Freq) %>% 
  select(-Pred) %>%
  scale(center = F) # Z-scores
rownames(tabtbl) <- colnames(tabtbl)
pheatmap(tabtbl, cluster_rows = F, cluster_cols = F, )

```




```{r}
anne$classification_metrics()
```

```{r}

imp_list <- anne$importance()

save(imp_list, file='results/male_CV_pairs_importance_round2.rda')

imp_list
```

```{r}
load('results/male_CV_pairs_importance_round2.rda')


df1 <- data.frame(Top15=1:15, Cluster='cluster1',imp_list[['cluster1']][1:15,])
df2 <- data.frame(Top15=1:15, Cluster='cluster2',imp_list[['cluster2']][1:15,])
df3 <- data.frame(Top15=1:15, Cluster='cluster3',imp_list[['cluster3']][1:15,])
df4 <- data.frame(Top15=1:15, Cluster='cluster4',imp_list[['cluster4']][1:15,])
df5 <- data.frame(Top15=1:15, Cluster='cluster5',imp_list[['cluster5']][1:15,])

impdf <- rbind(df1[,c(1,2,4)],df2[,c(1,2,4)],df3[,c(1,2,4)],df4[,c(1,2,4)],df5[,c(1,2,4)])

colnames(impdf) <- c('Top15','Cluster','Med_Info_Gain')

#ggplot(impdf, aes(Top15)) + 
#  geom_line(aes(y=cluster1),color="black") +
#  geom_line(aes(y=cluster2),color="orange") +
#  geom_line(aes(y=cluster3),color="skyblue") +
#  geom_line(aes(y=cluster4),color="darkgreen") +
#  geom_line(aes(y=cluster5),color="red") +
#  xlab('Top 15 gene pairs') + 
#  ylab('Median information gain')

ggplot(impdf, aes(x=Top15,y=Med_Info_Gain,color=Cluster)) + geom_line()



```




```{r}
#ensemble_rocs(anne)
plot_roc(anne, 1, flip=T)
```

```{r}
#ensemble_rocs(anne)
plot_roc(anne, 2, flip=T)
```

```{r}
#ensemble_rocs(anne)
plot_roc(anne, 3, flip=T)
```

```{r}
#ensemble_rocs(anne)
plot_roc(anne, 4, flip=T)
```

```{r}
#ensemble_rocs(anne)
plot_roc(anne, 5, flip=T)
```

```{r}
### FEMALES ###
```

```{r}
dat.f <- read_csv('data/Females_Array_Data_CW.csv')
load('data/feature_pairs_female_v3_round2.csv')
genelist_f <- genelist
# removing signature genes that are not available in our data sets
female.jive.gene.list <- readRDS("data/Female_jive_cluster_genes_CW.rds") %>% dplyr::filter(value %in% colnames(dat.f))
```

```{r}
table(dat.f$cluster.group)
```

```{r}
length(genelist)
```

```{r}
genelist_f <- genelist

sigs_f <- list("C1"=female.jive.gene.list$value[female.jive.gene.list$cluster.group == 'cluster1'],
               "C2"=female.jive.gene.list$value[female.jive.gene.list$cluster.group == 'cluster2'],
               "C3"=female.jive.gene.list$value[female.jive.gene.list$cluster.group == 'cluster3'],
               "C4"=female.jive.gene.list$value[female.jive.gene.list$cluster.group == 'cluster4'],
               "C5"=female.jive.gene.list$value[female.jive.gene.list$cluster.group == 'cluster5']
)


# our classifier object named Roberta
buffy <- Robencla$new("buffy")

# xgboost parameters to pass to each sub-classifier in the ensembles
  # xgboost parameters to pass to each sub-classifier in the ensembles
  params <- list(max_depth=12,   # "height" of the tree, 6 is actually default. I think about 12 seems better.  (xgboost parameter)
                 eta=0.2,        # this is the learning rate. smaller values slow it down, more conservative   (xgboost parameter)
                 nrounds=24,     # number of rounds of training, lower numbers less overfitting (potentially)  (xgboost parameter)
                 nthreads=5,     # parallel threads
                 gamma=0.5,      # Minimum loss reduc req'd to again partition a leaf node. higher number ~ more conservative (xgboost parameter)
                 lambda=1.5,     # L2 regularization term on weights, higher number ~ more conservative (xgboost parameter)
                 alpha=0.5,      # L1 regularization term on weights. higher number ~ more conservative (xgboost parameter)
                 verbose=0,
                 train_perc=0.8,
                 combine_function='median',
                 size=11
  )
```

```{r}

# First we use the training data
buffy$autocv(data_file='data/Females_Array_Data_CW.csv',
               label_name='cluster.group',
               sample_id = 'sample',
               data_mode=c('pairs'), # pairs,sigpairs,quartiles,tertiles,binarize,ranks,original #
               signatures=NULL,
               pair_list=genelist_f,  # subset to these genes.
               params=params,
               cv_rounds=10
              )

```

```{r}
df.f <- buffy$cv_results
df.f$cluster1 <- as.numeric(df.f$cluster1)
df.f$cluster2 <- as.numeric(df.f$cluster2)
df.f$cluster3 <- as.numeric(df.f$cluster3)
df.f$cluster4 <- as.numeric(df.f$cluster4)
df.f$cluster5 <- as.numeric(df.f$cluster5)
head(df.f)

write.table(as.data.frame(df.f), 'results/female_cv_pairs_round2.csv', sep=',', quote = F, row.names = F)
```

```{r}
df.f <- read.csv('results/female_cv_pairs_round2.csv')

tabdf <- table(Pred=df.f$BestCalls, True=df.f$Label)

tabtbl <- as.data.frame(tabdf) %>% 
  pivot_wider(id_cols = Pred,names_from = True, values_from = Freq) %>% 
  select(-Pred) %>%
  scale(center = F) # Z-scores
rownames(tabtbl) <- colnames(tabtbl)

pheatmap(tabtbl, cluster_rows = F, cluster_cols = F)

```

```{r}
buffy$classification_metrics()
```

```{r}

imp_list <- buffy$importance()

save(imp_list, file='results/female_CV_pairs_importance_round2.rda')
```


```{r}
load('results/female_CV_pairs_importance_round2.rda')


df1 <- data.frame(Top15=1:15, Cluster='cluster1',imp_list[['cluster1']][1:15,])
df2 <- data.frame(Top15=1:15, Cluster='cluster2',imp_list[['cluster2']][1:15,])
df3 <- data.frame(Top15=1:15, Cluster='cluster3',imp_list[['cluster3']][1:15,])
df4 <- data.frame(Top15=1:15, Cluster='cluster4',imp_list[['cluster4']][1:15,])
df5 <- data.frame(Top15=1:15, Cluster='cluster5',imp_list[['cluster5']][1:15,])

impdf <- rbind(df1[,c(1,2,4)],df2[,c(1,2,4)],df3[,c(1,2,4)],df4[,c(1,2,4)],df5[,c(1,2,4)])

colnames(impdf) <- c('Top15','Cluster','Med_Info_Gain')

#ggplot(impdf, aes(Top15)) + 
#  geom_line(aes(y=cluster1),color="black") +
#  geom_line(aes(y=cluster2),color="orange") +
#  geom_line(aes(y=cluster3),color="skyblue") +
#  geom_line(aes(y=cluster4),color="darkgreen") +
#  geom_line(aes(y=cluster5),color="red") +
#  xlab('Top 15 gene pairs') + 
#  ylab('Median information gain')

ggplot(impdf, aes(x=Top15,y=Med_Info_Gain,color=Cluster)) + geom_line()



```



```{r}
#ensemble_rocs(anne)
plot_roc(buffy, 1, flip=T)
```

```{r}
#ensemble_rocs(anne)
plot_roc(buffy, 2, flip=F)
```

```{r}
#ensemble_rocs(anne)
plot_roc(buffy, 3, flip=F)
```

```{r}
#ensemble_rocs(anne)
plot_roc(buffy, 4, flip=T)
```

```{r}
#ensemble_rocs(anne)
plot_roc(buffy, 5, flip=F)
```

```{r}
#FIN
```

