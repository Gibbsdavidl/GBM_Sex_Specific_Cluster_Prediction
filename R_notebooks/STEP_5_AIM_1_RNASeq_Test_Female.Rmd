---
title: An R Markdown document converted from "STEP_5_AIM_1_RNASeq_Test.ipynb"
output: html_document
---


```{r}
#devtools::install_github("gibbsdavidl/robencla", ref = 'v0.3.4')
```

```{r}
library(tidyverse)
library(robencla)
library(pheatmap)
library(readr)
```


```{r}




# Take the data set, and filter out pair genes that are not present.

clean_genepairs_list <- function(genepairs, dat_x) {
  genepairs_clean <- list()
  i <- 1
  for (pi in names(genepairs)) {
    genes <- genepairs[[pi]]
    missing_genes <- unique( genes [! genes %in% colnames(dat_x)] )
    print(paste0(pi, '  ', missing_genes))
    newpairlist <- c()
    for (j in seq.int(from=1,to=length(genes), by=2)) {
      if ( (genes[j] %in% missing_genes) | (genes[j+1] %in% missing_genes) ) {
        # then don't add them!
        print(paste0("removing from pair list:  ", genes[j], ' ', genes[j+1]))
      } else {
        newpairlist <- c(newpairlist, genes[j], genes[j+1])
      }
    }
    genepairs_clean[[pi]] <- newpairlist
  }
  return(genepairs_clean)
}

# pairlist is a list of vectors (paired terms)
# n is the number of pairs for each entry desired

shorter_and_clean <- function(pairlist, n) {
  newlist <- list()
  for (ni in names(pairlist)) {
    newlist[[ni]] <- str_replace_all(pairlist[[ni]][1:(2*n)], '\\.', '_')
  }
  return(newlist)  
}


```

```{r}

load('../data/F_processed_data.rda')
load('../results/females_genepairs.rda')


```


```{r}

gpairs <- shorter_and_clean(genepairs, 10)
genepairs_cl <- clean_genepairs_list(gpairs, dat_f)  # only one with missing genes
genepairs_cl <- clean_genepairs_list(genepairs_cl, tcga_f)  # only one with missing genes


# what if ...
dat_f$ClusterLabel2 <- ifelse(dat_f$ClusterLabel == 'cluster3', yes = 'C3', no='notC3')
c3_pairs <- list()
c3_pairs[['C3']] <- genepairs_cl$cluster3
c3_pairs[['notC3']] <- c(genepairs_cl$cluster1, genepairs_cl$cluster2, genepairs_cl$cluster4, genepairs_cl$cluster5)



# xgboost parameters to pass to each sub-classifier in the ensembles
params1 <- list(max_depth=12,   # "height" of the tree, 6 is actually default.   (xgboost parameter)
               eta=0.45,        # this is the learning rate. smaller values , more  conservative   (xgboost parameter)
               nrounds=24,     # number of rounds of training, lower numbers less overfitting  (xgboost parameter)
               early_stopping_rounds=2,
               nthreads=8,     # parallel threads
               gamma=0.2,      # Minimum loss req'd to again partition a leaf node. higher~ conservative (xgboost)
               lambda=2.5,     # L2 regularization term on weights, higher number ~ more conservative (xgboost parameter)
               alpha=0.25,      # L1 regularization term on weights. higher number ~ more conservative (xgboost parameter)
               verbose=0,
               train_perc=0.8,
               combine_function='median',
               size=11
)

mod_f <- robencla::Robencla$new('f_model')


mod_f$train(data_frame=dat_f,
            label_name='ClusterLabel2',
            sample_id = 'Barcode',
            drop_list = c(), #c('Sex'),
            data_mode=c('pairs'), # pairs, allpairs, sigpairs, quartiles, tertiles, binarize, ranks, original #
            signatures=NULL,
            pair_list=c3_pairs, #genepairs_cl,  # subset to these genes.
            params=params1
            )

# run the model
mod_f$predict(data_frame = tcga_f, 
              sample_id = 'Barcode',
              label_name = 'ClusterLabel')


table(Pred=mod_f$results()$BestCall, True=mod_f$test_label)

#mod_f$importance()



```

# orig
#           True
# Pred       cluster1 cluster2 cluster3 cluster4 cluster5
#   cluster1        9        1        0        1        0
#   cluster3        0        0        2        0        0
#   cluster4        0        0        0        7        0
#   cluster5        3        2        1        2       12


If we just look at separating out cluster 3:
We can do it with the exception of a single sample:

       True
Pred    cluster1 cluster2 cluster3 cluster4 cluster5
  C3           0        0        2        0        0
  notC3       12        3        1       10       12
  
  

It's the cluster 2 features that are not working well with the rna-seq.
But the second one down is very good.


> annot_f[annot_f$gene_i_symbol == 'HILPDA' & annot_f$gene_j_symbol == 'BANF1',]
          X  ...1  cluster  pair gene_i gene_j prop_this_cluster prop_not_cluster sum_dist_cluster sum_dist_not_cluster avg_dist_cluster
79942 79942 43755 cluster2 43755   4206  11562         0.7916667        0.1217391         12.57318            -92.87488         0.576846
      avg_dist_not_cluster med_dist_cluster med_dist_not_cluster prop_diff n1  n2 gene_i_symbol gene_j_symbol     score
79942           -0.9766246        0.5238826           -0.8200106 0.6699275 24 115        HILPDA         BANF1 0.3774117


> head(sort(annot_f$score[annot_f$cluster == 'cluster2'], decreasing = T))
[1] 0.3934685 0.3774117 0.3608053 0.3592932 0.3463266 0.3408711


