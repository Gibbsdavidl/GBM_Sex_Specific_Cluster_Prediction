---
title: An R Markdown document converted from "STEP_5_AIM_1_RNASeq_Test.ipynb"
output: html_document
---

Changes:

* Subsetting to genes that are present in all data sources.. array, RNA-seq, and TEMPUS. 10363 genes.
* Subsetting the JIVE gene signatures to those present genes.

Questions: Are there missing genes, in array, that are present in RNA-seq, that would be better to have for TEMPUS?



```{r}
#devtools::install_github("gibbsdavidl/robencla", force = F)
```

```{r}
library(tidyverse)
library(robencla)
library(pheatmap)
```

```{r}
#setwd("E:/Work/GBM_clusters/Classifier_Workflow")
#arr_f <- read_csv('data/Females_Array_Data_CW.csv')
#rna_f <- read_csv('data/Females_RNASeq_Data_CW.csv')
arr_f <- read_csv('data/Females_CV_Data_v3.csv')
rna_f <- read_csv('data/Females_RNASeq_Data_v3.csv')
load('data/feature_pairs_female_v3_round3.rda')
```

```{r}
table(arr_f$cluster.group)
dim(arr_f)
dim(rna_f)
genelist

```

```{r}

# results list
resl <- list()
print('starting')

# for a number of iterations, could be more
for (i in 1:200) {

  idx <- sample(1:nrow(rna_f),size=5,replace = F)
  sampleidx <- rna_f$sample[idx]

  dfa3 <- arr_f[!(arr_f$sample %in% sampleidx), ]
  dfb3 <- rna_f[c(idx), ]

  # our classifier object named Anne.
  anne <- Robencla$new("Anne")

  # xgboost parameters to pass to each sub-classifier in the ensembles
  params <- list(max_depth=12,   # "height" of the tree, 6 is actually default. I think about 12 seems better.  (xgboost parameter)
                 eta=0.2,        # this is the learning rate. smaller values slow it down, more conservative   (xgboost parameter)
                 nrounds=24,     # number of rounds of training, lower numbers less overfitting (potentially)  (xgboost parameter)
                 nthreads=5,     # parallel threads
                 gamma=0.5,      # Minimum loss reduc req'd to again partition a leaf node. higher number ~ more conservative (xgboost parameter)
                 lambda=1.5,     # L2 regularization term on weights, higher number ~ more conservative (xgboost parameter)
                 alpha=0.5,      # L1 regularization term on weights. higher number ~ more conservative (xgboost parameter)
                 verbose=0,
                 train_perc=0.8,
                 combine_function='median',
                 size=11
  )

  # First we use the training data
  anne$autotrain(data_frame = dfa3,
                 label_name='cluster_group',
                 sample_id = 'sample',
                 data_mode=c('pairs','quartiles'),  # pairs,sigpairs,quartiles,tertiles,binary,ranks,original #
                 signatures=NULL,
                 pair_list=genelist,  # subset to these genes.
                 params=params,
                 verbose=0)

  # now we apply the classifier to a test set.
  anne$autotest(data_frame = dfb3,#[,colnames(dfa2)], #'data/Males_RNASeq_Data_v3.csv',
                label_name='cluster_group',
                sample_id = 'sample',
                verbose=0)

  #table(Pred=anne$results()$BestCall, True=anne$test_label)
  resl[[i]] <- data.frame(Round=i,   anne$results()$SampleIDs, Pred=anne$results()$BestCall, True=anne$test_label)
}

```


```{r}
resdf <- do.call("rbind", resl)

tabdf <- table(Pred=resdf$Pred, True=resdf$True)
```

```{r}
head(resdf)
```


```{r}
tabtbl <- as.data.frame(tabdf) %>% 
  pivot_wider(id_cols = Pred,names_from = True, values_from = Freq) %>% 
  select(-Pred) %>%
  scale(center = F) # Z-scores
rownames(tabtbl) <- colnames(tabtbl)
pheatmap(tabtbl, cluster_rows = F, cluster_cols = F)

```




```{r}
xdf <- (resdf[resdf$True=='cluster2',2:4]) %>% arrange(anne.results...SampleIDs)
colnames(xdf)[1] <- 'SampleID'
ggplot(data=xdf, aes(x=as.factor(Pred), fill=as.factor(SampleID))) + geom_bar() + xlab("Predicted Cluster")
#ggsave(filename = 'results/female_rnaseq_test_pairs_quantiles_200_cluster1.png')
```


```{r}

write.table(as.data.frame(resdf), 'results/female_rnaseq_pairs_quantiles_round3_200.csv', sep=',', quote = F, row.names = F)

```


